variant: fcos
version: 1.6.0
# Tailscale via Podman Quadlet
# Runs tailscaled in a container with host networking and required privileges
# to manage the host network stack via /dev/net/tun.
#
# State directory on host: /var/lib/tailscale
# Runtime directory on host: /var/run/tailscale (created at service start)
# Environment file: /etc/tailscale/tailscale.env
# First boot: If TS_AUTHKEY is provided, the node will auto-register.
# Otherwise, run: sudo podman exec tailscaled tailscale up
storage:
  directories:
    - path: /var/lib/tailscale # Persistent state for Tailscale
      mode: 0755
      user:
        id: 1000
      group:
        id: 1000
    - path: /etc/tailscale # Configuration directory
      mode: 0755
  files:
    - path: /etc/modules-load.d/tun.conf
      overwrite: true
      contents:
        inline: tun

    # Provide a default env file so Quadlet EnvironmentFile= doesn't fail if the user hasn't created one yet.
    # Safe defaults: empty TS_EXTRA_ARGS, TS_STATE_DIR, and a commented TS_AUTHKEY line.
    - path: /etc/tailscale/tailscale.env
      mode: 0640
      contents:
        inline: |
          # Tailscale environment variables
          # Provide an auth key to auto-register (or leave commented):
          # TS_AUTHKEY=tskey-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
          #
          # State directory inside the container
          TS_STATE_DIR=/var/lib/tailscale
          #
          # Socket directory inside the container
          TS_SOCKET_DIR=/var/run/tailscale
          #
          # Extra flags passed to tailscaled (optional), e.g.:
          # TS_EXTRA_ARGS=--advertise-exit-node --accept-dns=true
          TS_EXTRA_ARGS=
          #
          # Authenticate to browser (optional)
          TS_AUTHENTICATE_TO_BROWSER=true
    - path: /etc/containers/systemd/tailscale.container
      mode: 0644
      contents:
        inline: |-
          [Unit]
          Description=Tailscale (container)
          Wants=network-online.target
          After=network-online.target

          [Container]
          Image=ghcr.io/tailscale/tailscale:stable
          ContainerName=tailscale
          Network=host
          AddCapability=NET_ADMIN NET_RAW
          AddDevice=/dev/net/tun
          SecurityLabelDisable=true
          # Persist state on the host
          Volume=/var/lib/tailscale:/var/lib/tailscale:Z
          # Machine identity helps with stable node identity
          Volume=/etc/machine-id:/etc/machine-id:ro
          # Load env file (now ensured to exist)
          EnvironmentFile=/etc/tailscale/tailscale.env
          # Default environment (container-side)
          Environment=TS_STATE_DIR=/var/lib/tailscale
          # Run tailscaled in the foreground
          Exec=/usr/local/bin/tailscaled --state=${TS_STATE_DIR}/tailscaled.state ${TS_EXTRA_ARGS}

          # Logging to journald for easier debugging
          LogDriver=journald

          # Persistent storage
          Volume=/var/lib/tailscale:/var/lib/tailscale:Z
          Volume=/etc/machine-id:/etc/machine-id:ro
          Volume=/var/run/tailscale:/var/run/tailscale

          # Environment variables
          EnvironmentFile=/etc/tailscale/tailscale.env

          # Execution
          Exec=/usr/local/bin/tailscaled --state=${TS_STATE_DIR}/tailscaled.state --socket=${TS_SOCKET_DIR}/tailscaled.sock
          AutoUpdate=registry

          [Service]
          Restart=always
          RestartSec=5
          TimeoutStartSec=300
          TimeoutStopSec=30

          # Pre-start hooks
          ExecStartPre=/bin/mkdir -p /var/run/tailscale
          ExecStartPre=/bin/chown -R 1000:1000 /var/run/tailscale

          [Install]
          WantedBy=multi-user.target
