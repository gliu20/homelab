variant: fcos
version: 1.6.0
# Cockpit via Podman Quadlet
# Run the official cockpit/ws container in privileged mode using host networking.
storage:
  files:
    # Ensure password auth is allowed for Cockpit login (optional if using other auth)
    - path: /etc/ssh/sshd_config.d/02-enable-passwords.conf
      mode: 0644
      contents:
        inline: |
          PasswordAuthentication yes
    # Podman Quadlet: define the Cockpit container
    - path: /etc/containers/systemd/cockpit.container
      mode: 0644
      contents:
        inline: |
          [Unit]
          Description=Cockpit Web Console (container)
          Wants=network-online.target
          After=network-online.target

          [Container]
          Image=quay.io/cockpit/ws:latest
          # Match image RUN label intent: run privileged
          PodmanArgs=--privileged
          # Use host network
          Network=host
          # Avoid issues combining privileged with split cgroups on some podman versions
          CgroupsMode=enabled
          # Avoid SELinux denials for host access in privileged container
          SecurityLabelDisable=true
          # Log to journald for easier debugging
          LogDriver=journald

          # Host integration mounts (not strictly required with --privileged, but useful)
          Volume=/run/dbus/system_bus_socket:/run/dbus/system_bus_socket
          Volume=/run/systemd/journal:/run/systemd/journal
          Volume=/etc/machine-id:/etc/machine-id:ro
          Volume=/run/udev:/run/udev:ro
          Volume=/sys/fs/cgroup:/sys/fs/cgroup:ro
          Volume=/etc/localtime:/etc/localtime:ro
          Volume=/etc/hostname:/etc/hostname:ro
          Volume=/run/NetworkManager:/run/NetworkManager:ro
          # Optional: Podman socket mount removed to avoid failure when socket is not present

          # Auto-update image from registry when available
          AutoUpdate=registry

          [Service]
          # Pull image explicitly before starting so TimeoutStartSec applies clearly
          ExecStartPre=/bin/sh -c '/usr/bin/podman pull --retry=5 --retry-delay=15s quay.io/cockpit/ws:latest'
          # Ensure we pull the newest image when starting
          Pull=true
          # Increase start timeout for slow pulls/starts
          TimeoutStartSec=3600s
          # Keep container running and auto-restart
          Restart=always
          # Back off between restarts to avoid thrashing while debugging
          RestartSec=3
          # Disable start rate limiting to avoid "start request repeated too quickly"
          StartLimitIntervalSec=0
          StartLimitBurst=0
          # Graceful stop
          TimeoutStopSec=30s
          # Helpful env for tooling and logs
          Environment=CONTAINERS_SYSTEMD_UNIT=%n

          [Install]
          WantedBy=multi-user.target
# Quadlet will synthesize cockpit.service from cockpit.container and apply [Install].
